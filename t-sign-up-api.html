<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../t-shared-lib/t-provider-behavior.html">
<dom-module id="t-sign-up-api">
    <template>
        <iron-ajax id="ajaxCall" method="PUT" content-type="application/json" handle-as="json" verbose>
        </iron-ajax>
    </template>
</dom-module>
<script>
Polymer({
    is: "t-sign-up-api",

    behaviors: [TravelNxt.Behaviors.ProviderBehavior],

    listeners: {
        'ajaxCall.response': '_successCallback',
        'ajaxCall.error': '_errorCallback'
    },

    signUp: function(data) {
        //validate API meta before making a call
        if (this._validateApiMeta()) {
            var request = {
                userName: data.email,
                password: data.password,
                email: {
                    isPrimary: true,
                    value: data.email
                },
                name: {
                    firstName: data.firstName,
                    lastName: data.lastName,
                    title: ""
                },
                dateOfBirth: {
                    date: new Date(data.dateOfBirth),
                    "time": "12:00 AM"
                }
            };
            this.$.ajaxCall.url = this._getUrl();
            this.$.ajaxCall.body = JSON.stringify(request);
            this._setLoading(true);
            this.$.ajaxCall.generateRequest();
        }
    },

    _successCallback: function(event) {
        var operationErrors = [316000, 316500, 500];
        
        var error = null;
        var success = null;
        if (!event.detail.response || !event.detail.response.status || !event.detail.response.status.code 
            || operationErrors.indexOf(event.detail.response.status.code)!= -1 
            || (!event.detail.response.status.isSuccessful && event.detail.response.status.code != 317100)){
            error = { message: 'Operation error occured, please try again.', code: 500};
            this.fire('t-sign-up-api-error', error, { bubbles: true });
        }
        else if(!event.detail.response.status.isSuccessful && event.detail.response.status.code == 317100 ){                        
            error = { message: 'Username is already in use, try another.', code: event.detail.response.status.code};
            this.fire('t-sign-up-api-error', error, { bubbles: true });         
        }
        else {            
            success = event.detail.response;
            this.fire('t-sign-up-api-success', success, {
                bubbles: true
            });
        }

        if(error)
            this._setLastError(error);
        else if(success)
            this._setLastResponse(success);

        this._setLoading(false);
    },

    _errorCallback: function(event) {
        var error ={ message: 'Connection error occured, please try again.', code: event.detail.request.status };
        this._setLastError(error);
        this._setLoading(false);

        this.fire('t-sign-up-api-error', error, { bubbles: true });
        console.error('t-sign-up-api-error', event);            
    },

});
</script>
