<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../t-notify/t-notify.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../t-input/t-input.html">
<link rel="import" href="../t-calendar/t-calendar.html">
<link rel="import" href="../t-password-input/t-password-input.html">
<link rel="import" href="../t-button/t-button.html">
<link rel="import" href="../t-shared-components/theme.html">

<dom-module id="t-sign-up">
    <template>
        <style>
            t-notify {
                margin-bottom: 10px;
            }
            
            t-button {
                display: block;
            }
            
            label, span, ul li {
                font-family: 'Open Sans', sans-serif;
                font-size: 12px;
            }
            
            label, span {
                color: #bbbbbb;
            }
            
            t-input + t-input, t-calendar + t-input, t-calendar {
                margin-top: 15px;
            }
        </style>

        <t-notify active="[[notification.isActive]]" type="[[notification.type]]" message="[[notification.message]]"> </t-notify>
        <t-input id="firstName" type="text" error-message="Invalid input!" pattern="[a-zA-Z ']*" max-length="10" label="First Name" required auto-validate> </t-input>
        <t-input id="lastName" type="text" error-message="Invalid input!" pattern="[a-zA-Z ']*" max-length="10" label="Last Name" required auto-validate> </t-input>
        <t-calendar id="dateOfBirth" label="Date Of Birth" is-dob required> </t-calendar>
        <t-input id="emailId" type="text" label="Email" on-value-changed="_userNameAvailability" required pattern='^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$' error-message="Invalid email!" autoValidate required> </t-input>
        <label>This will be used as your user name.</label>
        <t-password-input id="password"> </t-password-input>
        <span class="base">I have read and agree to terms of use and privacy policy.</span>
        <t-button class="primary" label="Create Account" raised on-click="_saveNewUser"> </t-button>
        <span class="base">If you are an existing user sign in here</span>
        <iron-ajax id="userAvailability" url="{{_generateUsernameUrl(apiBaseUrl)}}" content-type="application/json" on-response="_availabilityResponse"> </iron-ajax>
        <iron-ajax id="saveUser" url="{{apiBaseUrl}}user" method="PUT" content-type="application/json" on-response="_saveUserResponse"> </iron-ajax>

    </template>

    <script>
        Polymer({

            is: 't-sign-up',

            properties: {            
                token: String
            },

            attached: function() {
                this.apiBaseUrl = 'http://dev-mystiquecode.tavisca.com/api/';
            },

            _userNameAvailability: function() {

                this.set('notification.isActive', false);

                if(!this.$.emailId.value)
                    return;

                if (this.$.emailId.validate()) {

                    if(!this.token || this.token === ''){
                        this._notifyTokenStatus();
                        return;
                    }

                    this.$.userAvailability.url = this.apiBaseUrl + 'user/availability/' + this.$.emailId.value;
                    this.$.userAvailability.params = {
                        "token": this.token
                    };
                    this.$.userAvailability.generateRequest();
                }
            },

            _saveNewUser: function() {

                if (!this.validate())
                    return;

                if(!this.token || this.token === ''){
                    this._notifyTokenStatus();
                    return;
                }

                this.$.saveUser.params = {
                    token: this.token
                };
                this.$.saveUser.body = JSON.stringify(this._generateRequest());
                this.$.saveUser.generateRequest();
            },

            _generateRequest: function() {
                return {
                    userName: this.$.emailId.value,
                    password: this.$.password.password,
                    email: {
                        isPrimary: true,
                        value: this.$.emailId.value
                    },
                    name: {
                        firstName: this.$.firstName.value,
                        lastName: this.$.lastName.value,
                        title: ""
                    },
                    dateOfBirth: {
                        date: new Date(this.$.dateOfBirth.selectedDate),
                        "time": "12:00 AM"
                    }
                };
            },

            _availabilityResponse: function(e, data) {
                this.checkUserAvailabilityResponse = data.xhr.response;
                this._notifyAvailabilityResponse();
            },

            _saveUserResponse: function(e, data) {
                this.saveUserResponse = data.xhr.response;
                this._notifyUserResponse();
            },

            _notifyAvailabilityResponse: function() {
                if (!this.checkUserAvailabilityResponse || !this.checkUserAvailabilityResponse.status || !this.checkUserAvailabilityResponse.status.isSuccessful)
                    this.notification = {
                        isActive: true,
                        type: 'error',
                        message: 'failed to validate the user name'
                    };
                else if (this.checkUserAvailabilityResponse.result)
                    this.notification = {
                        isActive: true,
                        type: 'success',
                        message: 'User name available'
                    };
                else
                    this.notification = {
                        isActive: true,
                        type: 'warn',
                        message: 'User name already exists'
                    };

                this._hideNotification();
            },

            _notifyUserResponse: function() {

                if (!this.saveUserResponse || !this.saveUserResponse.status || !this.saveUserResponse.status.isSuccessful)
                    this.notification = {
                        isActive: true,
                        type: 'error',
                        message: 'Could not save the user'
                    };
                else
                    this.notification = {
                        isActive: true,
                        type: 'success',
                        message: 'User saved successfully'
                    }

                this._hideNotification();
            },

            _notifyTokenStatus:function () {
                this.notification = {
                    isActive: true,
                    type: 'error',
                    message: 'Auth token not available'
                };                
            },

            //to be removed once loaders are in place
            _hideNotification: function() {
                var self = this;
                setTimeout(function() {
                    self.set('notification.isActive', false);
                }, 5000);
            },

            _validateEmail:function () {
                if(this.checkUserAvailabilityResponse)
                    return this.$.emailId.validate() && this.checkUserAvailabilityResponse.result === true && isValidUser;
                return false;
            },

            validate: function() {

                var isValidUser = true;
                isValidUser = this.$.firstName.validate() && isValidUser;
                isValidUser = this.$.lastName.validate() && isValidUser;
                isValidUser = this.$.dateOfBirth.validate() && isValidUser;
                isValidUser = this._validateEmail();
                isValidUser = this.$.password.validate() && isValidUser;
                return isValidUser;
            }
        });
    </script>
</dom-module>