<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<!-- <link rel="import" href="../t-loader/t-loader.html"> -->
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../t-input/t-input.html">
<link rel="import" href="../t-calendar/t-calendar.html">
<link rel="import" href="../t-password-input/t-password-input.html">
<link rel="import" href="../t-button/t-button.html">
<link rel="import" href="./t-sign-up-api.html">
<link rel="import" href="../t-shared-components/theme.html">
<!--
    `t-sign-up` is a registration component used for registrating new users.
    This component considers email as default user name.
    The email id is validated for its uniqueness using API call.
    'on-t-sign-up-validate-email' event is fired when validation needs to be done.
    The event handler should use 't-validate-email-api' component's 'validateEmail' method to check availability.
    'on-t-sign-up-register' is fired while saving user data.
    The event handler should use 't-sign-up-api' component's 'signUp' method to save user.

Example:
        without event handlers
        <t-sign-up></t-sign-up>

        with event handlers
        <t-sign-up
            on-t-sign-up-register="registerEventHandler" 
            on-t-sign-up-validate-email="validateEmailEventHandler">
        </t-sign-up>-->
<dom-module id="t-sign-up">
    <template>
        <style>
        t-loader {
            position: absolute;
            top: 50%;
            left: 40%;
        }
        
        t-button {
            display: block;
        }
        
        label,
        span,
        ul li {
            font-family: 'Open Sans', sans-serif;
            font-size: 12px;
        }
        
        label,
        span {
            color: #bbbbbb;
        }
        
        t-input + t-input,
        t-calendar + t-input,
        t-calendar {
            margin-top: 15px;
        }
        </style>
        <!-- <t-loader id="loader"></t-loader> -->
        <paper-toast id="toast"></paper-toast>
        <t-input id="firstName" value="{{firstName}}" type="text" error-message="Invalid input!" pattern="[a-zA-Z ']*" max-length="10" label="First Name" required auto-validate>
        </t-input>
        <t-input id="lastName" value="{{lastName}}" type="text" error-message="Invalid input!" pattern="[a-zA-Z ']*" max-length="10" label="Last Name" required auto-validate>
        </t-input>
        <t-calendar id="dateOfBirth" selected-date="{{dateOfBirth}}" label="Date Of Birth" is-dob required>
        </t-calendar>
        <t-input id="emailId" value="{{emailId}}" type="text" label="Email" on-value-changed="_userNameAvailability" required pattern='^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$' error-message="Invalid email!" autoValidate required>
        </t-input>
        <label>This will be used as your user name.</label>
        <t-password-input id="password" value="{{password}}">
        </t-password-input>
        <span class="base">I have read and agree to terms of use and privacy policy.</span>
        <t-button class="primary" label="Create Account" raised on-click="_saveNewUser">
        </t-button>
        <span class="base">If you are an existing user sign in here</span>
    </template>
</dom-module>
<script>
Polymer({

    is: 't-sign-up',

    properties: {

        /**
         * first name of user.
         * This field is required.
         */
        firstName: String,

        /**
         * last nae of user.
         * This field is required.
         */
        lastName: String,

        /**
         * Email id of user.
         * This is a required field and is used as user name in application.
         */
        emailId: String,

        /**
         * Password.
         * Atleast 8 characters.
         */
        password: String,

        /**
         * date of birth of user
         * This is a required field.
         */
        dateOfBirth: String
    },

    attached: function() {},

    _userNameAvailability: function() {

        if (this.emailId && this.$.emailId.validate()) {
            // this.$.loader.active = true;
            this.fire('t-sign-up-validate-email', {
                email: this.emailId
            });
        }
    },

    _saveNewUser: function() {
        if (!this.validate())
            return;
        // this.$.loader.active = true;
        this.fire('t-sign-up-register', this._generateRequest());
    },

    _generateRequest: function() {
        return {
            email: this.emailId,
            password: this.password,
            firstName: this.firstName,
            lastName: this.lastName,
            dateOfBirth: new Date(this.dateOfBirth)
        };
    },

    _availabilityResponse: function(e, data) {
        this.checkUserAvailabilityResponse = data.xhr.response;
    },

    _saveUserResponse: function(e, data) {
        this.saveUserResponse = data.xhr.response;
    },

    notify: function(data) {
        // this.$.toast.text = data;
        // this.$.toast.open();
        // this.$.loader.active = false;
    },

    validate: function() {

        var isValidUser = true;
        isValidUser = this.$.firstName.validate() && isValidUser;
        isValidUser = this.$.lastName.validate() && isValidUser;
        isValidUser = this.$.dateOfBirth.validate() && isValidUser;
        isValidUser = this.$.emailId.validate();
        isValidUser = this.$.password.validate() && isValidUser;
        return isValidUser;
    }
});
</script>
