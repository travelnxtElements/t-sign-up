<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../t-loader/t-loader.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../t-input/t-input.html">
<link rel="import" href="../t-calendar/t-calendar.html">
<link rel="import" href="../t-password-input/t-password-input.html">
<link rel="import" href="../t-button/t-button.html">
<link rel="import" href="../t-text-container/travel-element-styles.html">
<link rel="import" href="./t-sign-up-api.html">
<!--
    `t-sign-up` is a registration component used for registrating new users.
    This component considers email as default user name.
    The email id is validated for its uniqueness using API call.
    'on-t-sign-up-validate-email' event is fired when validation needs to be done.
    The event handler should use 't-user-availability-api' component's 'checkAvailability' method to check availability.
    'on-t-sign-up-register' is fired while saving user data.
    The event handler should use 't-sign-up-api' component's 'signUp' method to save user.

Example:
        without event handlers
        <t-sign-up></t-sign-up>

        with event handlers
        <t-sign-up
            on-t-sign-up-register="registerEventHandler" 
            on-t-sign-up-validate-email="checkAvailabilityEventHandler">
        </t-sign-up>-->
<dom-module id="t-sign-up">
    <template>
        <style include="travel-element-styles">
        :host {
            font-family: var(--primary-font-family, 'Open sans');
            font-size: var(--font-12, 12px);
            display: block;
        }
        
        .loader-container {
            position: relative;
        }
        
        #loader {
            position: absolute;
            right: 10px;
            bottom: 5px;
            transform: scale(0.5);
        }
        </style>
        <div class="secondary-text section">
            <t-input id="firstName" value="{{firstName}}" type="text" error-message="You missed this." pattern="[a-zA-Z ']*" max-length="10" label="First Name" class="margin-bottom-medium" required auto-validate></t-input>
            <t-input id="lastName" value="{{lastName}}" type="text" error-message="You missed this." pattern="[a-zA-Z ']*" max-length="10" label="Last Name" class="margin-bottom-medium" required auto-validate></t-input>
            <t-calendar id="dateOfBirth" selected-date="{{dateOfBirth}}" max="{{_getMaxDateOfBirth(minAge)}}" label="Date Of Birth" is-dob class="margin-bottom-medium" error-message="You missed this." required></t-calendar>
            <div class="loader-container">
                <t-input id="emailId" value="{{emailId}}" type="text" label="Email" on-change="_userNameAvailability" class="margin-bottom-medium" pattern='^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$' error-message="You missed this." auto-validate required></t-input>
                <template is="dom-if" if="[[userChecking]]">
                    <t-loader id="loader" active></t-loader>
                </template>
            </div>
            <label class="margin-bottom block">Note* Email will be used as your user name.</label>
            <t-password-input id="password" value="{{password}}" class="margin-bottom-medium" required>
            </t-password-input>
            <label class="margin-bottom block">By clicking 
                <i>Create Account</i>, you agree to
                <a href$="[[policiesUrl]]" target="_blank" class$="{{_checkIfUrl(policiesUrl)}}">anti-spam policy</a> and 
                <a href$="[[termsUrl]]" target="_blank" class$="{{_checkIfUrl(termsUrl)}}">terms of use</a>.
            </label>
            <t-button class="primary block margin-bottom" label="Create Account" raised on-click="_saveNewUser">
            </t-button>
            <div class="margin-bottom">If you are an existing user <a class="link-style" on-tap="_goToSignInPage">sign in</a> here</div>
        </div>
    </template>
</dom-module>
<script>
Polymer({

    is: 't-sign-up',

    properties: {

        /**
         * first name of user.
         * This field is required.
         */
        firstName: String,

        /**
         * last nae of user.
         * This field is required.
         */
        lastName: String,

        /**
         * Email id of user.
         * This is a required field and is used as user name in application.
         */
        emailId: String,

        /**
         * Password.
         * Atleast 8 characters.
         */
        password: String,

        /**
         * Pass a string as URL for policy
         */
        policiesUrl: {
            type: String
        },

        /**
         *  Pass a string as URL for term and condition
         */
        termsUrl: {
            type: String
        },

        /**
         *  Pass the minimum age of the User to get registered
         */
        minAge: {
            type: Number,
            value: 11
        }


    },

    _checkIfUrl: function(url) {
        if (url.length > 0) {
            return 'link-style';
        }
    },

    _getMaxDateOfBirth: function(minAge) {
        var date = new Date();
        return new Date(date.setFullYear(date.getFullYear() - minAge));
    },

    _userNameAvailability: function() {

        if (this.emailId && this.$.emailId.validate()) {
            // this.$.loader.active = true;
            this.fire('t-sign-up-validate-email', {
                email: this.emailId
            });
            this.userChecking = true;
        }
    },

    _saveNewUser: function() {
        if (!this.validate())
            return;
        // this.$.loader.active = true;
        this.fire('t-sign-up-register', this._generateRequest());
    },

    _goToSignInPage: function() {
        this.fire('t-go-sign-in');
    },

    _generateRequest: function() {
        return {
            email: this.emailId,
            password: this.password,
            firstName: this.firstName,
            lastName: this.lastName,
            dateOfBirth: new Date(this.dateOfBirth)
        };
    },

    /*Run the method when the response comes back with response */
    onEmailValidate: function() {
        this.userChecking = false;
    },

    /**
     * To run the validate method in the entire component
     * This is a required field.
     */
    validate: function() {
        var check = true;
        var x = this.querySelectorAll('[required]');
        for (var i = 0; i < x.length; i++) {
            if (!x[i].validate()) {
                check = false;
            }
        }
        return check;
    }
});
</script>
