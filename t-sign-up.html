<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<!-- <link rel="import" href="../t-loader/t-loader.html"> -->
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../t-input/t-input.html">
<link rel="import" href="../t-calendar/t-calendar.html">
<link rel="import" href="../t-password-input/t-password-input.html">
<link rel="import" href="../t-button/t-button.html">
<link rel="import" href="../t-shared-components/theme.html">
<link rel="import" href="../t-text-container/travel-element-styles.html">
<link rel="import" href="./t-sign-up-api.html">
<!--
    `t-sign-up` is a registration component used for registrating new users.
    This component considers email as default user name.
    The email id is validated for its uniqueness using API call.
    'on-t-sign-up-validate-email' event is fired when validation needs to be done.
    The event handler should use 't-validate-email-api' component's 'validateEmail' method to check availability.
    'on-t-sign-up-register' is fired while saving user data.
    The event handler should use 't-sign-up-api' component's 'signUp' method to save user.

Example:
        without event handlers
        <t-sign-up></t-sign-up>

        with event handlers
        <t-sign-up
            on-t-sign-up-register="registerEventHandler" 
            on-t-sign-up-validate-email="validateEmailEventHandler">
        </t-sign-up>-->
<dom-module id="t-sign-up">
    <template>
        <style include="travel-element-styles">
        :host {
            font-family: var(--primary-font-family, 'Open sans');
            font-size: var(--font-12, 12px);
            display: block;
        }
        
        </style>
        <div class="secondary-text section">
            <t-input id="firstName" value="{{firstName}}" type="text" error-message="Invalid input!" pattern="[a-zA-Z ']*" max-length="10" label="First Name" class="margin-bottom-medium" required ></t-input>

            <t-input id="lastName" value="{{lastName}}" type="text" error-message="Invalid input!" pattern="[a-zA-Z ']*" max-length="10" label="Last Name" class="margin-bottom-medium" required ></t-input>

            <t-calendar id="dateOfBirth" selected-date="{{dateOfBirth}}" label="Date Of Birth" is-dob class="margin-bottom-medium" required></t-calendar>

            <t-input id="emailId" value="{{emailId}}" type="text" label="Email" on-change="_userNameAvailability" class="margin-bottom-medium" pattern='^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$' error-message="Invalid email!" autoValidate required></t-input>

            <label class="margin-bottom block">Note* Email will be used as your user name.</label>
            <t-password-input id="password" value="{{password}}" class="margin-bottom-medium" required>
            </t-password-input>
            <label class="margin-bottom block">I have read and agree to terms of use and privacy policy.</label>
            <t-button class="primary block margin-bottom" label="Create Account" raised on-click="_saveNewUser">
            </t-button>
            <div class="margin-bottom">If you are an existing user <a class="link-style">sign in</a> here</div>
        </div>
    </template>
</dom-module>
<script>
Polymer({

    is: 't-sign-up',

    properties: {

        /**
         * first name of user.
         * This field is required.
         */
        firstName: String,

        /**
         * last nae of user.
         * This field is required.
         */
        lastName: String,

        /**
         * Email id of user.
         * This is a required field and is used as user name in application.
         */
        emailId: String,

        /**
         * Password.
         * Atleast 8 characters.
         */
        password: String,

        /**
         * date of birth of user
         * This is a required field.
         */
        dateOfBirth: String
    },

    attached: function() {},

    _userNameAvailability: function() {

        if (this.emailId && this.$.emailId.validate()) {
            // this.$.loader.active = true;
            this.fire('t-sign-up-validate-email', {
                email: this.emailId
            });
        }
    },

    _saveNewUser: function() {
        if (!this.validate())
            return;
        // this.$.loader.active = true;
        this.fire('t-sign-up-register', this._generateRequest());
    },

    _generateRequest: function() {
        return {
            email: this.emailId,
            password: this.password,
            firstName: this.firstName,
            lastName: this.lastName,
            dateOfBirth: new Date(this.dateOfBirth)
        };
    },

    /**
     * To run the validate method in the entire component
     * This is a required field.
     */
    validate: function() {
        var check = true;
        var x = this.querySelectorAll('[required]');
        for (var i = 0; i < x.length; i++) {
            if (!x[i].validate()) {
                check = false;
            }
        }
        return check;
    }
});
</script>
